"use strict";
const lib_1 = require("../../lib");
const serialize_1 = require("../../lib/serialize");
const mock_sdk_1 = require("../util/mock-sdk");
module.exports = {
    async 'do bootstrap'(test) {
        // GIVEN
        const sdk = new mock_sdk_1.MockSDK();
        let executed = false;
        sdk.stubCloudFormation({
            describeStacks() {
                return {
                    Stacks: []
                };
            },
            createChangeSet(info) {
                const template = serialize_1.fromYAML(info.TemplateBody);
                const bucketProperties = template.Resources.StagingBucket.Properties;
                test.equals(bucketProperties.BucketName, undefined, 'Expected BucketName to be undefined');
                test.equals(bucketProperties.BucketEncryption.ServerSideEncryptionConfiguration[0].ServerSideEncryptionByDefault.KMSMasterKeyID, undefined, 'Expected KMSMasterKeyID to be undefined');
                return {};
            },
            describeChangeSet() {
                return {
                    Status: 'CREATE_COMPLETE',
                    Changes: [],
                };
            },
            executeChangeSet() {
                executed = true;
                return {};
            }
        });
        // WHEN
        const ret = await lib_1.bootstrapEnvironment({
            account: '123456789012',
            region: 'us-east-1',
            name: 'mock',
        }, sdk, 'mockStack', undefined);
        // THEN
        test.equals(ret.noOp, false);
        test.equals(executed, true);
        test.done();
    },
    async 'do bootstrap using custom bucket name'(test) {
        // GIVEN
        const sdk = new mock_sdk_1.MockSDK();
        let executed = false;
        sdk.stubCloudFormation({
            describeStacks() {
                return {
                    Stacks: []
                };
            },
            createChangeSet(info) {
                const template = serialize_1.fromYAML(info.TemplateBody);
                const bucketProperties = template.Resources.StagingBucket.Properties;
                test.equals(bucketProperties.BucketName, 'foobar', 'Expected BucketName to be foobar');
                test.equals(bucketProperties.BucketEncryption.ServerSideEncryptionConfiguration[0].ServerSideEncryptionByDefault.KMSMasterKeyID, undefined, 'Expected KMSMasterKeyID to be undefined');
                return {};
            },
            describeChangeSet() {
                return {
                    Status: 'CREATE_COMPLETE',
                    Changes: [],
                };
            },
            executeChangeSet() {
                executed = true;
                return {};
            }
        });
        // WHEN
        const ret = await lib_1.bootstrapEnvironment({
            account: '123456789012',
            region: 'us-east-1',
            name: 'mock',
        }, sdk, 'mockStack', undefined, {
            bucketName: 'foobar',
        });
        // THEN
        test.equals(ret.noOp, false);
        test.equals(executed, true);
        test.done();
    },
    async 'do bootstrap using KMS CMK'(test) {
        // GIVEN
        const sdk = new mock_sdk_1.MockSDK();
        let executed = false;
        sdk.stubCloudFormation({
            describeStacks() {
                return {
                    Stacks: []
                };
            },
            createChangeSet(info) {
                const template = serialize_1.fromYAML(info.TemplateBody);
                const bucketProperties = template.Resources.StagingBucket.Properties;
                test.equals(bucketProperties.BucketName, undefined, 'Expected BucketName to be undefined');
                test.equals(bucketProperties.BucketEncryption.ServerSideEncryptionConfiguration[0].ServerSideEncryptionByDefault.KMSMasterKeyID, 'myKmsKey', 'Expected KMSMasterKeyID to be myKmsKey');
                return {};
            },
            describeChangeSet() {
                return {
                    Status: 'CREATE_COMPLETE',
                    Changes: [],
                };
            },
            executeChangeSet() {
                executed = true;
                return {};
            }
        });
        // WHEN
        const ret = await lib_1.bootstrapEnvironment({
            account: '123456789012',
            region: 'us-east-1',
            name: 'mock',
        }, sdk, 'mockStack', undefined, {
            kmsKeyId: 'myKmsKey',
        });
        // THEN
        test.equals(ret.noOp, false);
        test.equals(executed, true);
        test.done();
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5ib290c3RyYXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0ZXN0LmJvb3RzdHJhcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUEsbUNBQWlEO0FBQ2pELG1EQUErQztBQUMvQywrQ0FBMkM7QUFFM0MsaUJBQVM7SUFDUCxLQUFLLENBQUMsY0FBYyxDQUFDLElBQVU7UUFDN0IsUUFBUTtRQUNSLE1BQU0sR0FBRyxHQUFHLElBQUksa0JBQU8sRUFBRSxDQUFDO1FBRTFCLElBQUksUUFBUSxHQUFHLEtBQUssQ0FBQztRQUVyQixHQUFHLENBQUMsa0JBQWtCLENBQUM7WUFDckIsY0FBYztnQkFDWixPQUFPO29CQUNMLE1BQU0sRUFBRSxFQUFFO2lCQUNYLENBQUM7WUFDSixDQUFDO1lBRUQsZUFBZSxDQUFDLElBQTBCO2dCQUN4QyxNQUFNLFFBQVEsR0FBRyxvQkFBUSxDQUFDLElBQUksQ0FBQyxZQUFzQixDQUFDLENBQUM7Z0JBQ3ZELE1BQU0sZ0JBQWdCLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDO2dCQUNyRSxJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsRUFBRSxTQUFTLEVBQUUscUNBQXFDLENBQUMsQ0FBQztnQkFDM0YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxnQkFBZ0IsQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyw2QkFBNkIsQ0FBQyxjQUFjLEVBQzdILFNBQVMsRUFBRSx5Q0FBeUMsQ0FBQyxDQUFDO2dCQUN4RCxPQUFPLEVBQUUsQ0FBQztZQUNaLENBQUM7WUFFRCxpQkFBaUI7Z0JBQ2YsT0FBTztvQkFDTCxNQUFNLEVBQUUsaUJBQWlCO29CQUN6QixPQUFPLEVBQUUsRUFBRTtpQkFDWixDQUFDO1lBQ0osQ0FBQztZQUVELGdCQUFnQjtnQkFDZCxRQUFRLEdBQUcsSUFBSSxDQUFDO2dCQUNoQixPQUFPLEVBQUUsQ0FBQztZQUNa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Z0JBQ3JFLElBQUksQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxFQUFFLFNBQVMsRUFBRSxxQ0FBcUMsQ0FBQyxDQUFDO2dCQUMzRixJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLGdCQUFnQixDQUFDLGlDQUFpQyxDQUFDLENBQUMsQ0FBQyxDQUFDLDZCQUE2QixDQUFDLGNBQWMsRUFDN0gsVUFBVSxFQUFFLHdDQUF3QyxDQUFDLENBQUM7Z0JBQ3hELE9BQU8sRUFBRSxDQUFDO1lBQ1osQ0FBQztZQUVELGlCQUFpQjtnQkFDZixPQUFPO29CQUNMLE1BQU0sRUFBRSxpQkFBaUI7b0JBQ3pCLE9BQU8sRUFBRSxFQUFFO2lCQUNaLENBQUM7WUFDSixDQUFDO1lBRUQsZ0JBQWdCO2dCQUNkLFFBQVEsR0FBRyxJQUFJLENBQUM7Z0JBQ2hCLE9BQU8sRUFBRSxDQUFDO1lBQ1osQ0FBQztTQUNGLENBQUMsQ0FBQztRQUVILE9BQU87UUFDUCxNQUFNLEdBQUcsR0FBRyxNQUFNLDBCQUFvQixDQUFDO1lBQ3JDLE9BQU8sRUFBRSxjQUFjO1lBQ3ZCLE1BQU0sRUFBRSxXQUFXO1lBQ25CLElBQUksRUFBRSxNQUFNO1NBQ2IsRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRTtZQUM5QixRQUFRLEVBQUUsVUFBVTtTQUNyQixDQUFDLENBQUM7UUFFSCxPQUFPO1FBQ1AsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzdCLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRTVCLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNkLENBQUM7Q0FDRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ3JlYXRlQ2hhbmdlU2V0SW5wdXQgfSBmcm9tICdhd3Mtc2RrL2NsaWVudHMvY2xvdWRmb3JtYXRpb24nO1xuaW1wb3J0IHsgVGVzdCB9IGZyb20gJ25vZGV1bml0JztcbmltcG9ydCB7IGJvb3RzdHJhcEVudmlyb25tZW50IH0gZnJvbSAnLi4vLi4vbGliJztcbmltcG9ydCB7IGZyb21ZQU1MIH0gZnJvbSAnLi4vLi4vbGliL3NlcmlhbGl6ZSc7XG5pbXBvcnQgeyBNb2NrU0RLIH0gZnJvbSAnLi4vdXRpbC9tb2NrLXNkayc7XG5cbmV4cG9ydCA9IHtcbiAgYXN5bmMgJ2RvIGJvb3RzdHJhcCcodGVzdDogVGVzdCkge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc2RrID0gbmV3IE1vY2tTREsoKTtcblxuICAgIGxldCBleGVjdXRlZCA9IGZhbHNlO1xuXG4gICAgc2RrLnN0dWJDbG91ZEZvcm1hdGlvbih7XG4gICAgICBkZXNjcmliZVN0YWNrcygpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBTdGFja3M6IFtdXG4gICAgICAgIH07XG4gICAgICB9LFxuXG4gICAgICBjcmVhdGVDaGFuZ2VTZXQoaW5mbzogQ3JlYXRlQ2hhbmdlU2V0SW5wdXQpIHtcbiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBmcm9tWUFNTChpbmZvLlRlbXBsYXRlQm9keSBhcyBzdHJpbmcpO1xuICAgICAgICBjb25zdCBidWNrZXRQcm9wZXJ0aWVzID0gdGVtcGxhdGUuUmVzb3VyY2VzLlN0YWdpbmdCdWNrZXQuUHJvcGVydGllcztcbiAgICAgICAgdGVzdC5lcXVhbHMoYnVja2V0UHJvcGVydGllcy5CdWNrZXROYW1lLCB1bmRlZmluZWQsICdFeHBlY3RlZCBCdWNrZXROYW1lIHRvIGJlIHVuZGVmaW5lZCcpO1xuICAgICAgICB0ZXN0LmVxdWFscyhidWNrZXRQcm9wZXJ0aWVzLkJ1Y2tldEVuY3J5cHRpb24uU2VydmVyU2lkZUVuY3J5cHRpb25Db25maWd1cmF0aW9uWzBdLlNlcnZlclNpZGVFbmNyeXB0aW9uQnlEZWZhdWx0LktNU01hc3RlcktleUlELFxuICAgICAgICAgIHVuZGVmaW5lZCwgJ0V4cGVjdGVkIEtNU01hc3RlcktleUlEIHRvIGJlIHVuZGVmaW5lZCcpO1xuICAgICAgICByZXR1cm4ge307XG4gICAgICB9LFxuXG4gICAgICBkZXNjcmliZUNoYW5nZVNldCgpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBTdGF0dXM6ICdDUkVBVEVfQ09NUExFVEUnLFxuICAgICAgICAgIENoYW5nZXM6IFtdLFxuICAgICAgICB9O1xuICAgICAgfSxcblxuICAgICAgZXhlY3V0ZUNoYW5nZVNldCgpIHtcbiAgICAgICAgZXhlY3V0ZWQgPSB0cnVlO1xuICAgICAgICByZXR1cm4ge307XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgcmV0ID0gYXdhaXQgYm9vdHN0cmFwRW52aXJvbm1lbnQoe1xuICAgICAgYWNjb3VudDogJzEyMzQ1Njc4OTAxMicsXG4gICAgICByZWdpb246ICd1cy1lYXN0LTEnLFxuICAgICAgbmFtZTogJ21vY2snLFxuICAgIH0sIHNkaywgJ21vY2tTdGFjaycsIHVuZGVmaW5lZCk7XG5cbiAgICAvLyBUSEVOXG4gICAgdGVzdC5lcXVhbHMocmV0Lm5vT3AsIGZhbHNlKTtcbiAgICB0ZXN0LmVxdWFscyhleGVjdXRlZCwgdHJ1ZSk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcbiAgYXN5bmMgJ2RvIGJvb3RzdHJhcCB1c2luZyBjdXN0b20gYnVja2V0IG5hbWUnKHRlc3Q6IFRlc3QpIHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHNkayA9IG5ldyBNb2NrU0RLKCk7XG5cbiAgICBsZXQgZXhlY3V0ZWQgPSBmYWxzZTtcblxuICAgIHNkay5zdHViQ2xvdWRGb3JtYXRpb24oe1xuICAgICAgZGVzY3JpYmVTdGFja3MoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgU3RhY2tzOiBbXVxuICAgICAgICB9O1xuICAgICAgfSxcblxuICAgICAgY3JlYXRlQ2hhbmdlU2V0KGluZm86IENyZWF0ZUNoYW5nZVNldElucHV0KSB7XG4gICAgICAgIGNvbnN0IHRlbXBsYXRlID0gZnJvbVlBTUwoaW5mby5UZW1wbGF0ZUJvZHkgYXMgc3RyaW5nKTtcbiAgICAgICAgY29uc3QgYnVja2V0UHJvcGVydGllcyA9IHRlbXBsYXRlLlJlc291cmNlcy5TdGFnaW5nQnVja2V0LlByb3BlcnRpZXM7XG4gICAgICAgIHRlc3QuZXF1YWxzKGJ1Y2tldFByb3BlcnRpZXMuQnVja2V0TmFtZSwgJ2Zvb2JhcicsICdFeHBlY3RlZCBCdWNrZXROYW1lIHRvIGJlIGZvb2JhcicpO1xuICAgICAgICB0ZXN0LmVxdWFscyhidWNrZXRQcm9wZXJ0aWVzLkJ1Y2tldEVuY3J5cHRpb24uU2VydmVyU2lkZUVuY3J5cHRpb25Db25maWd1cmF0aW9uWzBdLlNlcnZlclNpZGVFbmNyeXB0aW9uQnlEZWZhdWx0LktNU01hc3RlcktleUlELFxuICAgICAgICAgIHVuZGVmaW5lZCwgJ0V4cGVjdGVkIEtNU01hc3RlcktleUlEIHRvIGJlIHVuZGVmaW5lZCcpO1xuICAgICAgICByZXR1cm4ge307XG4gICAgICB9LFxuXG4gICAgICBkZXNjcmliZUNoYW5nZVNldCgpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBTdGF0dXM6ICdDUkVBVEVfQ09NUExFVEUnLFxuICAgICAgICAgIENoYW5nZXM6IFtdLFxuICAgICAgICB9O1xuICAgICAgfSxcblxuICAgICAgZXhlY3V0ZUNoYW5nZVNldCgpIHtcbiAgICAgICAgZXhlY3V0ZWQgPSB0cnVlO1xuICAgICAgICByZXR1cm4ge307XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgcmV0ID0gYXdhaXQgYm9vdHN0cmFwRW52aXJvbm1lbnQoe1xuICAgICAgYWNjb3VudDogJzEyMzQ1Njc4OTAxMicsXG4gICAgICByZWdpb246ICd1cy1lYXN0LTEnLFxuICAgICAgbmFtZTogJ21vY2snLFxuICAgIH0sIHNkaywgJ21vY2tTdGFjaycsIHVuZGVmaW5lZCwge1xuICAgICAgYnVja2V0TmFtZTogJ2Zvb2JhcicsXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgdGVzdC5lcXVhbHMocmV0Lm5vT3AsIGZhbHNlKTtcbiAgICB0ZXN0LmVxdWFscyhleGVjdXRlZCwgdHJ1ZSk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcbiAgYXN5bmMgJ2RvIGJvb3RzdHJhcCB1c2luZyBLTVMgQ01LJyh0ZXN0OiBUZXN0KSB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzZGsgPSBuZXcgTW9ja1NESygpO1xuXG4gICAgbGV0IGV4ZWN1dGVkID0gZmFsc2U7XG5cbiAgICBzZGsuc3R1YkNsb3VkRm9ybWF0aW9uKHtcbiAgICAgIGRlc2NyaWJlU3RhY2tzKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIFN0YWNrczogW11cbiAgICAgICAgfTtcbiAgICAgIH0sXG5cbiAgICAgIGNyZWF0ZUNoYW5nZVNldChpbmZvOiBDcmVhdGVDaGFuZ2VTZXRJbnB1dCkge1xuICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IGZyb21ZQU1MKGluZm8uVGVtcGxhdGVCb2R5IGFzIHN0cmluZyk7XG4gICAgICAgIGNvbnN0IGJ1Y2tldFByb3BlcnRpZXMgPSB0ZW1wbGF0ZS5SZXNvdXJjZXMuU3RhZ2luZ0J1Y2tldC5Qcm9wZXJ0aWVzO1xuICAgICAgICB0ZXN0LmVxdWFscyhidWNrZXRQcm9wZXJ0aWVzLkJ1Y2tldE5hbWUsIHVuZGVmaW5lZCwgJ0V4cGVjdGVkIEJ1Y2tldE5hbWUgdG8gYmUgdW5kZWZpbmVkJyk7XG4gICAgICAgIHRlc3QuZXF1YWxzKGJ1Y2tldFByb3BlcnRpZXMuQnVja2V0RW5jcnlwdGlvbi5TZXJ2ZXJTaWRlRW5jcnlwdGlvbkNvbmZpZ3VyYXRpb25bMF0uU2VydmVyU2lkZUVuY3J5cHRpb25CeURlZmF1bHQuS01TTWFzdGVyS2V5SUQsXG4gICAgICAgICAgJ215S21zS2V5JywgJ0V4cGVjdGVkIEtNU01hc3RlcktleUlEIHRvIGJlIG15S21zS2V5Jyk7XG4gICAgICAgIHJldHVybiB7fTtcbiAgICAgIH0sXG5cbiAgICAgIGRlc2NyaWJlQ2hhbmdlU2V0KCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIFN0YXR1czogJ0NSRUFURV9DT01QTEVURScsXG4gICAgICAgICAgQ2hhbmdlczogW10sXG4gICAgICAgIH07XG4gICAgICB9LFxuXG4gICAgICBleGVjdXRlQ2hhbmdlU2V0KCkge1xuICAgICAgICBleGVjdXRlZCA9IHRydWU7XG4gICAgICAgIHJldHVybiB7fTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCByZXQgPSBhd2FpdCBib290c3RyYXBFbnZpcm9ubWVudCh7XG4gICAgICBhY2NvdW50OiAnMTIzNDU2Nzg5MDEyJyxcbiAgICAgIHJlZ2lvbjogJ3VzLWVhc3QtMScsXG4gICAgICBuYW1lOiAnbW9jaycsXG4gICAgfSwgc2RrLCAnbW9ja1N0YWNrJywgdW5kZWZpbmVkLCB7XG4gICAgICBrbXNLZXlJZDogJ215S21zS2V5JyxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICB0ZXN0LmVxdWFscyhyZXQubm9PcCwgZmFsc2UpO1xuICAgIHRlc3QuZXF1YWxzKGV4ZWN1dGVkLCB0cnVlKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxufTtcbiJdfQ==